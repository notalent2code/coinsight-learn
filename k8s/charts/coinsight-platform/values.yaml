# Coinsight Platform Configuration
# This file contains default values for the Coinsight microservices platform

# Kubernetes-native configuration management
configMaps:
  enabled: true

secrets:
  enabled: true
  # Database credentials
  database:
    username: "postgres"
    password: "postgres"
  
  # Keycloak client secrets - These will be populated by init-keycloak-realm.sh script
  # The secrets are managed by Kubernetes and updated automatically when clients are created
  keycloak:
    # Placeholder values - actual secrets generated by Keycloak and updated by init script
    authServiceSecret: "placeholder-will-be-replaced"
    budgetServiceSecret: "placeholder-will-be-replaced"
    notificationServiceSecret: "placeholder-will-be-replaced"
    gatewayClientSecret: "placeholder-will-be-replaced"
    ocrServiceSecret: "placeholder-will-be-replaced"
    transactionServiceSecret: "placeholder-will-be-replaced"
  
  # Azure API keys (replace with your actual keys)
  azure:
    formRecognizerApiKey: "2G2FhKKSMQIGInRgpEYKYZIrsHeJKPLPrLS9e6vnSJgu4LJwFM0tJQQJ99BEACqBBLyXJ3w3AAAAACOG0aZg"
    openaiApiKey: "1IqZw7IsgY8qzgwH3XAxcEGp7qBCQThKmmo8VJVIL0Ics6jwZbScJQQJ99BEACHYHv6XJ3w3AAAAACOGxchg"
  
  # Mail credentials
  mail:
    username: ""
    password: ""

# External service configuration
coinsightRealm: "coinsight-realm"

# Database Initialization
dbInit:
  enabled: true

azure:
  formRecognizer:
    endpoint: "https://coinsight-ocr.cognitiveservices.azure.com/"
  openai:
    endpoint: "https://rihla-maz4futt-eastus2.cognitiveservices.azure.com/"
    deploymentId: "gpt-4.1"

mail:
  host: "coinsight-platform-mailhog.coinsight.svc.cluster.local"
  port: "1025"

# MailHog for development email testing
mailhog:
  enabled: true
  image:
    repository: "mailhog/mailhog"
    tag: "v1.0.1"
    pullPolicy: IfNotPresent
  service:
    type: NodePort
    nodePort: 31025  # MailHog web UI accessible at http://localhost:31025
  resources:
    requests:
      memory: "32Mi"
      cpu: "10m"
    limits:
      memory: "64Mi"
      cpu: "50m"

global:
  namespace: "coinsight"

  # Global image settings
  image:
    registry: "docker.io"
    pullPolicy: IfNotPresent
    tag: "latest"
  
  # Global security context
  securityContext:
    runAsNonRoot: true
    runAsUser: 1001
    fsGroup: 1001
  
  # Resource limits (optimized for faster startup)
  resources:
    limits:
      memory: "1Gi"
      cpu: "1000m"

# Infrastructure Dependencies
postgres-auth:
  enabled: true
  auth:
    database: "auth_service"
    username: "postgres"
    password: "postgres"
  primary:
    persistence:
      size: 1Gi
    resources:
      requests:
        memory: "512Mi"
        cpu: "200m"
      limits:
        memory: "1Gi"
        cpu: "500m"

postgres-transaction:
  enabled: true
  auth:
    database: "transaction_service"
    username: "postgres"
    password: "postgres"
  primary:
    persistence:
      size: 2Gi
    resources:
      requests:
        memory: "512Mi"
        cpu: "200m"
      limits:
        memory: "1Gi"
        cpu: "500m"

postgres-budget:
  enabled: true
  auth:
    database: "budget_service"
    username: "postgres"
    password: "postgres"
  primary:
    persistence:
      size: 1Gi
    resources:
      requests:
        memory: "256Mi"
        cpu: "100m"
      limits:
        memory: "512Mi"
        cpu: "300m"

postgres-notification:
  enabled: true
  auth:
    database: "notification_service"
    username: "postgres"
    password: "postgres"
  primary:
    persistence:
      size: 1Gi
    resources:
      requests:
        memory: "256Mi"
        cpu: "100m"
      limits:
        memory: "512Mi"
        cpu: "300m"

postgres-keycloak:
  enabled: true
  auth:
    database: "keycloak"
    username: "postgres"
    password: "postgres"
  primary:
    persistence:
      size: 1Gi
    resources:
      requests:
        memory: "256Mi"
        cpu: "100m"
      limits:
        memory: "512Mi"
        cpu: "300m"

kafka:
  enabled: true
  # Disable KRaft for simpler single-broker setup with Zookeeper
  kraft:
    enabled: false
  # Disable controller since we're using Zookeeper mode
  controller:
    replicaCount: 0
  # Single Zookeeper node
  zookeeper:
    enabled: true
    replicaCount: 1
    resources:
      requests:
        memory: "256Mi"
        cpu: "100m"
      limits:
        memory: "512Mi"
        cpu: "300m"
    persistence:
      size: 1Gi
  # Single Kafka broker
  broker:
    replicaCount: 1
    resources:
      requests:
        memory: "512Mi"
        cpu: "100m"
      limits:
        memory: "1Gi"
        cpu: "500m"
    persistence:
      size: 2Gi
    readinessProbe:
      tcpSocket:
        port: 9092
      initialDelaySeconds: 30
      timeoutSeconds: 5
      periodSeconds: 10
      failureThreshold: 3
    livenessProbe:
      tcpSocket:
        port: 9092
      initialDelaySeconds: 60
      timeoutSeconds: 5
      periodSeconds: 10
      failureThreshold: 3
  # Simple listeners configuration
  listeners:
    client:
      protocol: PLAINTEXT
      port: 9092
    interbroker:
      protocol: PLAINTEXT
      port: 9094
  service:
    ports:
      client: 9092
  # Ensure proper Java heap settings
  heapOpts: "-Xmx512m -Xms512m"
  # Simple single-node configuration
  extraConfig: |
    # Single-node Kafka configuration with Zookeeper (broker.id handled by chart)
    
    # Listeners configuration
    listeners=PLAINTEXT://0.0.0.0:9092,INTERNAL://0.0.0.0:9094
    advertised.listeners=PLAINTEXT://coinsight-platform-kafka.coinsight.svc.cluster.local:9092,INTERNAL://coinsight-platform-kafka-broker-0.coinsight-platform-kafka-broker-headless.coinsight.svc.cluster.local:9094
    listener.security.protocol.map=PLAINTEXT:PLAINTEXT,INTERNAL:PLAINTEXT
    inter.broker.listener.name=INTERNAL
    
    # Single-node replication settings
    num.partitions=1
    default.replication.factor=1
    min.insync.replicas=1
    offsets.topic.replication.factor=1
    transaction.state.log.replication.factor=1
    transaction.state.log.min.isr=1
    
    # Performance settings
    num.network.threads=3
    num.io.threads=8
    socket.send.buffer.bytes=102400
    socket.receive.buffer.bytes=102400
    socket.request.max.bytes=104857600
    
    # Timeout configurations
    group.initial.rebalance.delay.ms=0
    group.max.session.timeout.ms=300000
    replica.fetch.timeout.ms=30000
    request.timeout.ms=30000
    
    # Leader election settings
    leader.imbalance.check.interval.seconds=30
    leader.imbalance.per.broker.percentage=5
    unclean.leader.election.enable=true
    
    # Connection settings
    connections.max.idle.ms=540000
    reconnect.backoff.ms=50
    reconnect.backoff.max.ms=1000
    
    # Auto topic creation
    auto.create.topics.enable=true
    
    # Log configuration
    log.retention.hours=24
    log.segment.bytes=1073741824
    log.retention.check.interval.ms=300000

redis:
  enabled: true
  auth:
    enabled: false
  master:
    resources:
      requests:
        memory: "128Mi"
        cpu: "50m"
      limits:
        memory: "256Mi"
        cpu: "200m"
    persistence:
      size: 1Gi

keycloak:
  enabled: true
  auth:
    adminUser: "admin"
    adminPassword: "admin"
  service:
    type: NodePort
    nodePorts:
      http: 30090
  postgresql:
    enabled: false  # We use our own postgres-keycloak
  externalDatabase:
    host: "coinsight-platform-postgres-keycloak"
    port: 5432
    user: "postgres"
    password: "postgres"
    database: "keycloak"
  resources:
    requests:
      memory: "512Mi"
      cpu: "200m"
    limits:
      memory: "1Gi"
      cpu: "500m"

# Microservices Configuration
microservices:
  # Config Server - DISABLED (migrated to ConfigMaps/Secrets)
  # configServer:
  #   enabled: false
  #   image:
  #     repository: "coinsight/config-server"
  #     tag: "latest"
  #   service:
  #     port: 8888
  #   resources:
  #     requests:
  #       memory: "128Mi"
  #       cpu: "50m"
  #     limits:
  #       memory: "256Mi"
  #       cpu: "200m"

  # Auth Service
  authService:
    enabled: true
    image:
      repository: "coinsight/auth-service"
      tag: "latest"
    service:
      port: 8081
    database:
      host: "coinsight-platform-postgres-auth"
    resources:
      requests:
        memory: "512Mi"
        cpu: "200m"
      limits:
        memory: "1Gi"
        cpu: "500m"

  # Transaction Service
  transactionService:
    enabled: true
    image:
      repository: "coinsight/transaction-service"
      tag: "latest"
    service:
      port: 8082
    database:
      host: "coinsight-platform-postgres-transaction"
    resources:
      requests:
        memory: "512Mi"
        cpu: "200m"
      limits:
        memory: "1Gi"
        cpu: "500m"

  # OCR Service
  ocrService:
    enabled: true
    image:
      repository: "coinsight/ocr-service"
      tag: "latest"
    service:
      port: 8083
    resources:
      requests:
        memory: "1Gi"
        cpu: "300m"
      limits:
        memory: "2Gi"
        cpu: "1000m"

  # Budget Service
  budgetService:
    enabled: true
    image:
      repository: "coinsight/budget-service"
      tag: "latest"
    service:
      port: 8084
    database:
      host: "coinsight-platform-postgres-budget"
    resources:
      requests:
        memory: "512Mi"
        cpu: "200m"
      limits:
        memory: "1Gi"
        cpu: "500m"

  # Notification Service
  notificationService:
    enabled: true
    image:
      repository: "coinsight/notification-service"
      tag: "latest"
    service:
      port: 8085
    database:
      host: "coinsight-platform-postgres-notification"
    resources:
      requests:
        memory: "512Mi"
        cpu: "200m"
      limits:
        memory: "1Gi"
        cpu: "500m"

  # Gateway Service - API Gateway
  gatewayService:
    enabled: true
    image:
      repository: "coinsight/gateway-service"
      tag: "latest"
    service:
      port: 8080
      type: NodePort
      nodePort: 30080
    resources:
      requests:
        memory: "1Gi"
        cpu: "500m"
      limits:
        memory: "2Gi"
        cpu: "1000m"

# Ingress Configuration
ingress:
  enabled: true
  className: "nginx"
  annotations:
    nginx.ingress.kubernetes.io/rewrite-target: /
  hosts:
    - host: coinsight.local
      paths:
        - path: /
          pathType: Prefix
          backend:
            service:
              name: gateway-service
              port:
                number: 8080

# Monitoring (optional, can be enabled later)
monitoring:
  enabled: false
  prometheus:
    enabled: false
  grafana:
    enabled: false
